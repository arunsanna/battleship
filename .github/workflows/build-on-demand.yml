name: build-on-demand

on:
  workflow_dispatch:
    inputs:
      name:
        description: "Container folder to build"
        required: true
        type: choice
        options:
          - alfa
          - cuda
          - diagnostics
          - kustomize
          - network
          - terraform
          - terragrunt
          - ubi-8-fips
          - ubi-8-micro
          - ubi-8-minimal
          - ubi-8-standard
      publish:
        description: "Push image to DockerHub"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: read
  security-events: write

concurrency:
  group: build-on-demand-${{ github.ref }}-${{ inputs.name }}
  cancel-in-progress: true

jobs:
  build-one:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < "${{ inputs.name }}/Dockerfile" || true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: inputs.publish == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and (optionally) push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ inputs.name }}
          platforms: linux/amd64,linux/arm64
          push: ${{ inputs.publish == 'true' }}
          tags: |
            arunsanna/${{ inputs.name }}:latest
            arunsanna/${{ inputs.name }}:${{ github.sha }}
          cache-from: type=registry,ref=arunsanna/${{ inputs.name }}:buildcache
          cache-to: type=registry,ref=arunsanna/${{ inputs.name }}:buildcache,mode=max

      - name: Run Trivy scanner
        if: inputs.publish == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: arunsanna/${{ inputs.name }}:latest
          format: 'sarif'
          output: trivy-results-${{ inputs.name }}.sarif

      - name: Upload Trivy results
        if: inputs.publish == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results-${{ inputs.name }}.sarif

