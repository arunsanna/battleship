name: build-images

on:
  push:
    branches: [ master, main ]
    paths:
      - 'alfa/**'
      - 'cuda/**'
      - 'diagnostics/**'
      - 'kustomize/**'
      - 'network/**'
      - 'terraform/**'
      - 'terragrunt/**'
      - 'ubi-8-fips/**'
      - 'ubi-8-micro/**'
      - 'ubi-8-minimal/**'
      - 'ubi-8-standard/**'
      - '.github/workflows/dockerimage.yml'
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      alfa: ${{ steps.filter.outputs.alfa }}
      cuda: ${{ steps.filter.outputs.cuda }}
      diagnostics: ${{ steps.filter.outputs.diagnostics }}
      kustomize: ${{ steps.filter.outputs.kustomize }}
      network: ${{ steps.filter.outputs.network }}
      terraform: ${{ steps.filter.outputs.terraform }}
      terragrunt: ${{ steps.filter.outputs.terragrunt }}
      ubi-8-fips: ${{ steps.filter.outputs.ubi-8-fips }}
      ubi-8-micro: ${{ steps.filter.outputs.ubi-8-micro }}
      ubi-8-minimal: ${{ steps.filter.outputs.ubi-8-minimal }}
      ubi-8-standard: ${{ steps.filter.outputs.ubi-8-standard }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            alfa:
              - 'alfa/**'
            cuda:
              - 'cuda/**'
            diagnostics:
              - 'diagnostics/**'
            kustomize:
              - 'kustomize/**'
            network:
              - 'network/**'
            terraform:
              - 'terraform/**'
            terragrunt:
              - 'terragrunt/**'
            ubi-8-fips:
              - 'ubi-8-fips/**'
            ubi-8-micro:
              - 'ubi-8-micro/**'
            ubi-8-minimal:
              - 'ubi-8-minimal/**'
            ubi-8-standard:
              - 'ubi-8-standard/**'

  build-alfa:
    needs: changes
    if: needs.changes.outputs.alfa == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < alfa/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./alfa
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/alfa:latest
            arunsanna/alfa:${{ github.sha }}

  build-cuda:
    needs: changes
    if: needs.changes.outputs.cuda == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < cuda/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./cuda
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/cuda:latest
            arunsanna/cuda:${{ github.sha }}

  build-diagnostics:
    needs: changes
    if: needs.changes.outputs.diagnostics == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < diagnostics/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./diagnostics
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/diagnostics:latest
            arunsanna/diagnostics:${{ github.sha }}

  build-kustomize:
    needs: changes
    if: needs.changes.outputs.kustomize == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < kustomize/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./kustomize
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/kustomize:latest
            arunsanna/kustomize:${{ github.sha }}

  build-network:
    needs: changes
    if: needs.changes.outputs.network == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < network/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./network
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/network:latest
            arunsanna/network:${{ github.sha }}

  build-terraform:
    needs: changes
    if: needs.changes.outputs.terraform == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < terraform/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./terraform
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/terraform:latest
            arunsanna/terraform:${{ github.sha }}

  build-terragrunt:
    needs: changes
    if: needs.changes.outputs.terragrunt == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < terragrunt/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./terragrunt
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/terragrunt:latest
            arunsanna/terragrunt:${{ github.sha }}

  build-ubi-8-fips:
    needs: changes
    if: needs.changes.outputs.ubi-8-fips == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < ubi-8-fips/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./ubi-8-fips
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/ubi-8-fips:latest
            arunsanna/ubi-8-fips:${{ github.sha }}

  build-ubi-8-micro:
    needs: changes
    if: needs.changes.outputs.ubi-8-micro == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < ubi-8-micro/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./ubi-8-micro
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/ubi-8-micro:latest
            arunsanna/ubi-8-micro:${{ github.sha }}

  build-ubi-8-minimal:
    needs: changes
    if: needs.changes.outputs.ubi-8-minimal == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < ubi-8-minimal/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./ubi-8-minimal
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/ubi-8-minimal:latest
            arunsanna/ubi-8-minimal:${{ github.sha }}

  build-ubi-8-standard:
    needs: changes
    if: needs.changes.outputs.ubi-8-standard == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Dockerfile
        run: docker run --rm -i hadolint/hadolint < ubi-8-standard/Dockerfile || true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        if: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./ubi-8-standard
          platforms: linux/amd64
          push: ${{ secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN }}
          tags: |
            arunsanna/ubi-8-standard:latest
            arunsanna/ubi-8-standard:${{ github.sha }}
